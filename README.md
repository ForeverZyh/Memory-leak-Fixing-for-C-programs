#ç¼–è¯‘å®ä¹ æŠ¥å‘Š-Cç¨‹åºå†…å­˜æ³„æ¼ä¿®å¤
å¼ ç…œçš“ã€æå¥•æˆã€é™ˆç‰§æ­Œ
#ä»£ç æ‰§è¡Œæ–¹æ³•
**ç¯å¢ƒ**

åœ¨Ubuntuä¸‹ï¼Œä½¿ç”¨

```
sudo apt-get install flex
sudo apt-get install bison
```

å®‰è£…å¿…è¦çš„flexä¸bison

**ä½¿ç”¨æ–¹å¼**

```
make clean
make
./parser in.c out.c
```

#é¡¹ç›®æè¿°

###**ç›®æ ‡é—®é¢˜**

æ—¨åœ¨è‡ªåŠ¨ä¿®å¤Cç¨‹åºä¸­æ½œåœ¨çš„å¯¼è‡´å†…å­˜æ³„æ¼çš„ä»£ç ã€‚

ç”±äºåˆ¤å®šä¸€æ®µç¨‹åºæ˜¯å¦å†…å­˜æ³„æ¼ä¸ºå›¾çµä¸å¯åˆ¤å®šé—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç¨‹åºçš„ä¿®å¤ç›®æ ‡ä¸ºï¼Œå°½é‡å¤šåœ°ä¿®å¤å‡ºé”™ä»£ç ã€‚

###**è§£å†³æ€è·¯**

å‰ç«¯->ä¸­é—´è¡¨ç¤º(CFG)->å‰ç«¯

é¦–è¦ä»»åŠ¡æ˜¯å°†ä»£ç è½¬æ¢ä¸ºä¸­é—´è¡¨ç¤ºä»è€Œæ–¹ä¾¿åˆ†æï¼Œæˆ‘ä»¬é€‰æ‹©äº†é€‚åˆåšæ•°æ®æµåˆ†æçš„CFGæ¥ä½œä¸ºä¸­é—´è¡¨ç¤ºã€‚

ç„¶åé€šè¿‡å¯¹ä¸­é—´è¡¨ç¤ºçš„åˆ†æï¼Œæ¥è®¡ç®—å¦‚ä½•ä¿®å¤ä»£ç ã€‚

æœ€åé€šè¿‡è®¡ç®—ç»“æœå¾—åˆ°ä¿®æ”¹åçš„Cä»£ç ã€‚

#å®ç°æ–¹æ¡ˆ

##å‰ç«¯->ä¸­é—´è¡¨ç¤º

è¿™éƒ¨åˆ†å¯ä»¥çœ‹`parser.l`éƒ¨åˆ†ä»£ç æ¥çœ‹å…·ä½“é€»è¾‘ã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†ä»£ç è½¬æ¢ä¸ºä¸­é—´è¡¨ç¤ºã€‚

å¾—åˆ°æŠ½è±¡è¯­æ³•æ ‘ä¹‹åï¼Œå°†å…¶åˆ†æè·å¾—CFGã€‚

è¯¥éƒ¨åˆ†ä»£ç å‚è€ƒ`cfg.c`

æˆ‘ä»¬é¦–å…ˆå¯¹æ¯ä¸ªå‡½æ•°éƒ½æ„å»ºäº†cfgï¼Œç„¶åæ‰§è¡ŒInterprocedural CFG* è¿‡ç¨‹æ¥åˆå¹¶å¾—åˆ°æ•´ä¸ªç¨‹åºçš„cfgã€‚

è¯¥éƒ¨åˆ†ä»£ç å‚è€ƒ`clone_build_graph.c`

###CFGnode

åœ¨æ­¤æˆ‘ä»¬æ€»å¾—æ¥ä»‹ç»ä¸€ä¸‹CFGnodeä¸­ä¿å­˜çš„å†…å®¹

```c
struct CFGnode
{
    vector<CFGnode*> succ,prev;
    expr defuse;
    vector<int> identifier_list,vars_to_kill;
    vector<pair<int,int> > list_of_vars;
    int isRrac,isLrac,ln,vis,vis2,vis3,vis4,tag,call_index;
    bool cantAfter,put_back,isFirst,isLast;
    G1 g1;
    G2 g2,g3;
    static int rac_cnt;
    static int flag;
}
```
* succå’Œprevè¡¨ç¤ºçš„æ˜¯å›¾ä¸­èŠ‚ç‚¹çš„åç»§å’Œå‰é©±
* defuseè¡¨ç¤ºçš„æ˜¯è¯¥èŠ‚ç‚¹ä¸­å„ä¸ªå˜é‡defineå’Œuseçš„å…³ç³»
* identifier_listä¿å­˜çš„æ˜¯è¯¥èŠ‚ç‚¹ä¸­å£°æ˜çš„å˜é‡
* vars\_to_killä¿å­˜çš„æ˜¯è¯¥èŠ‚ç‚¹ä¸­å¯ä»¥è¢«freeçš„å˜é‡å
* list\_of_varsä¿å­˜çš„æ˜¯å½“å‰èŠ‚ç‚¹ä½œç”¨åŸŸä¸­çš„å˜é‡ï¼ˆä¹ŸåŒ…å«ä¸€äº›å¹¶ä¸å­˜åœ¨äºç¨‹åºä¸­çš„å±€éƒ¨å˜é‡ï¼‰
* å¦‚æœè¯¥èŠ‚ç‚¹å®é™…å¯¹åº”ç€åŸç¨‹åºä¸­çš„ä¸€ä¸ªè¯­å¥çš„è¯ï¼Œlnä¼šä¿å­˜è¿™ä¸ªè¯­å¥æ‰€åœ¨çš„è¡Œå·
* isLrac(isRrac)è¡¨ç¤ºè¯¥è¯­å¥æ˜¯ä¸æ˜¯ä¸€ä¸ªå·¦ï¼ˆå³ï¼‰å¤§æ‹¬å·
* cantAfterè¡¨ç¤ºè¯¥è¯­å¥æ˜¯å¦æ˜¯ä¸€ä¸ªreturn,continue,breakç­‰è·³è½¬è¯­å¥ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ²¡å¿…è¦åœ¨åé¢æ·»åŠ free
* åœ¨lnæœ‰å€¼å­˜åœ¨ä¹‹æ—¶ï¼ŒisFirst(isLast)è¡¨ç¤ºçš„æ˜¯æ˜¯å¦æ˜¯è¯¥æ¡è¯­å¥çš„ç¬¬ä¸€ä¸ªç‚¹ï¼ˆæœ€åä¸€ä¸ªç‚¹ï¼‰ï¼Œå¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªç‚¹ï¼Œåˆ™ä¸èƒ½åœ¨è¿™ä¸ªç‚¹åé¢æ·»åŠ freeã€‚å› ä¸ºæˆ‘ä»¬æ— æ³•æ‹†åˆ†ä¸€æ¡è¯­å¥
* g1è¡¨ç¤ºçš„æ˜¯æŒ‡é’ˆåˆ†æçš„åŠæ ¼ï¼Œg2,g3è¡¨ç¤ºçš„æ˜¯ç¬¬ä¸€æ¬¡åˆ†æä¸ç¬¬äºŒæ¬¡åˆ†æçš„åŠæ ¼ã€‚


##åˆ†æéƒ¨åˆ†
###Point To Analysis 

å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„cfgä¹‹åï¼Œæˆ‘ä»¬ç«‹å³æ‰§è¡Œ`point_analysis(begin)`æ¥è¿›è¡ŒæŒ‡é’ˆåˆ†æï¼Œåˆ†æç»“æœç”¨äºåé¢æ•°æ®æµåˆ†æã€‚

ç›®æ ‡æ˜¯è·å¾—åœ¨æ¯ä¸ªCFGèŠ‚ç‚¹ä¸Šï¼Œå„ä¸ªå˜é‡æ‰€å¯èƒ½æŒ‡å‘çš„ä½ç½®ï¼Œä¹Ÿèƒ½å¤Ÿå¾—å‡ºå„ä¸ªå˜é‡ä¸­å¯èƒ½å­˜æ”¾ç€ç”±å“ªäº›mallocè¯­å¥å¼€è¾Ÿçš„å†…å­˜åœ°å€ã€‚

ä¼ ç»Ÿçš„æŒ‡å‘æ€§åˆ†æç®—æ³•åˆ†ä¸ºä¸¤ç§ï¼ŒSteensgaardå’ŒAndersonç®—æ³•ã€‚Andersonç®—æ³•çš„ç‰¹ç‚¹æ˜¯ç²¾åº¦é«˜ï¼Œä½†æ˜¯æ•ˆç‡ä½ä¸‹ï¼Œå¦‚æœå˜é‡ä¸ªæ•°ä¸ºnçš„è¯ï¼Œæ—¶é—´å¤æ‚åº¦å°†è¾¾åˆ°`O(n^3)`ã€‚Steensgaardç®—æ³•çš„ç‰¹ç‚¹æ˜¯ç²¾åº¦è¾ƒä½ï¼Œä½†æ˜¯æ•ˆç‡éå¸¸é«˜ï¼Œåˆ†æä¸€éçš„æ—¶é—´å¤æ‚åº¦ä¸º`O(nğ›¼(n))`ã€‚åœ¨æ­¤æˆ‘ä»¬é€‰æ‹©Steensgaardç®—æ³•ä½œä¸ºæˆ‘ä»¬æŒ‡é’ˆåˆ†æçš„ç®—æ³•ã€‚

ä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œä¸¤è€…éƒ½æ˜¯æµéæ•æ„Ÿçš„åˆ†æï¼Œè¿™åœ¨æˆ‘ä»¬è¿›è¡Œåˆ†æçš„æ—¶å€™å°†ååˆ†ä¸å‹å¥½ï¼Œç®€è€Œè¨€ä¹‹ä¼šå¯¼è‡´æä½çš„å‡†ç¡®åº¦ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å…¶ä¿®æ”¹ä¸ºæµæ•æ„Ÿçš„æŒ‡é’ˆåˆ†æã€‚å…¶æ–¹æ³•å°±æ˜¯ï¼š**åœ¨æ¯ä¸ªCFGèŠ‚ç‚¹ä¹‹ä¸­ä¿å­˜ä¸€ä»½åˆ†æçš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦å®ç°çš„å°±åªæœ‰ï¼š1ã€åŠ å…¥ä¸€ä¸ªæ“ä½œï¼›2ã€åˆå¹¶ä¸¤ä¸ªå¹¶æŸ¥é›†ã€‚å¯¹äºç¬¬ä¸€ç§æ“ä½œï¼Œæˆ‘ä»¬åƒä¼ ç»Ÿçš„Steensgaardä¸€æ ·æ›´æ”¹å¹¶æŸ¥é›†çš„ä¿¡æ¯ã€‚å¯¹äºç¬¬äºŒç§æ“ä½œï¼Œåˆå¹¶å¹¶æŸ¥é›†Aå’ŒBï¼Œè¦ä¿è¯xå’Œyåªè¦åœ¨Aæˆ–Bä¸­æ˜¯å¤„äºåŒä¸€ä¸ªé›†åˆï¼Œåœ¨æœ€åçš„é›†åˆä¸­Cï¼Œä¹Ÿè¦ä¿è¯xå’Œyåœ¨Cä¸­å±äºåŒä¸€ä¸ªé›†åˆã€‚è¿™ä¸€æ­¥å¯ä»¥åœ¨ä¹Ÿ`O(nğ›¼(n))`çš„æ—¶é—´å†…å®Œæˆã€‚æ•…æ€»æ—¶é—´å¤æ‚åº¦ä¸º`O(n^2ğ›¼(n))`ã€‚**

è¯¥éƒ¨åˆ†ä»£ç å‚è€ƒ`point_analysis.c`

###First Analysis 
æŒ‡é’ˆåˆ†æç»“æŸä¹‹åå°±å¯ä»¥è¿›è¡Œç¬¬ä¸€æ¬¡åˆ†æï¼Œè¿™ä¸€æ¬¡åˆ†æçš„ç›®æ ‡æ—¨åœ¨è·å¾—åœ¨æ¯ä¸ªCFGèŠ‚ç‚¹ä¸Šï¼Œå“ªäº›mallocè¯­å¥å¼€è¾Ÿçš„å†…å­˜åœ°å€å·²è¢«é‡Šæ”¾ã€‚

è¿™ä¸€æ­¥å®ç°å¾ˆæ–¹ä¾¿ï¼Œåˆ©ç”¨æˆ‘ä»¬ä¹‹å‰æŒ‡é’ˆåˆ†æå¾—åˆ°çš„ä¿¡æ¯ï¼Œåœ¨CFGä¸Šæ­£å‘åœ°æ‰§è¡Œç±»ä¼¼bfsçš„æµç¨‹ï¼ˆå¯èƒ½ä¼šæœ‰åå¤å…¥é˜Ÿï¼‰ï¼Œå°±å¯ä»¥è®¡ç®—åŠæ ¼äº†ã€‚

è¯¥éƒ¨åˆ†ä»£ç å‚è€ƒ`first_analysis.c`
###Second Analysis (Liveness Analysis)

ç„¶åè¿›è¡Œç¬¬äºŒæ¬¡åˆ†æï¼Œè¿™æ¬¡è¦åˆ†æå‡ºåœ¨æ¯ä¸ªCFGèŠ‚ç‚¹ä¸Šï¼Œå“ªäº›mallocè¯­å¥å¼€è¾Ÿçš„å†…å­˜åœ°å€åœ¨ä¹‹åè¿˜æ˜¯æ´»è·ƒçš„ã€‚

è¿™ä¸€æ­¥å®ç°ä¸ç¬¬ä¸€æ­¥ç±»ä¼¼ï¼Œæˆ‘ä»¬å€’ç€éå†CFGæ›´æ–°åŠæ ¼å³å¯ã€‚

è¯¥éƒ¨åˆ†ä»£ç å‚è€ƒ`second_analysis.c`
###Final Pass

åœ¨åšå®Œä¸¤æ¬¡åˆ†æä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å†³ç­–åœ¨å“ªäº›åœ°æ–¹æ’å…¥freeè¯­å¥æ¥ä¿®å¤å†…å­˜æ³„æ¼äº†ã€‚

å‡è®¾æœ‰u->vçš„è¾¹ï¼Œå¦‚æœè¦åœ¨uä¹‹åæ·»åŠ ä¸€æ¡free(x)è¯­å¥ï¼Œå¿…é¡»è¦æ»¡è¶³ï¼š

xä¸­å¯èƒ½æŒ‡å‘çš„mallocçš„åœ°å€åœ¨vä¹‹åä¸è¢«ä½¿ç”¨ï¼Œä¸”åœ¨uä¹‹å‰æœªè¢«é‡Šæ”¾

* ä½†æ˜¯è¿™é‡Œä¼šæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå¦‚æœuæ˜¯ä¸€ä¸ª`if`è¯­å¥çš„åˆ¤æ–­è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆuä¹‹åæœ‰ä¸¤æ¡è¾¹ï¼Œåˆ†åˆ«è¿å‘v1,v2ï¼Œé‚£ä¹ˆéœ€è¦åšçš„å°±æ˜¯åœ¨v1å’Œv2å‰éƒ½æ’å…¥free(x)è¯­å¥ã€‚

è€Œä¸”åœ¨å†³ç­–ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°ç¬¬ä¸€æ¬¡åˆ†æå’Œç¬¬äºŒæ¬¡åˆ†æçš„ç»“æœï¼Œä»è€Œç»§ç»­ä¿®å¤ã€‚

æ·»åŠ freeè¯­å¥çš„ç­–ç•¥ï¼Œæˆ‘ä»¬é€‰æ‹©è´ªå¿ƒï¼Œå°½å¯èƒ½æ—©åœ°æ·»åŠ freeè¯­å¥ã€‚

é€‰æ‹©è´ªå¿ƒæ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°æ—¶é—´ä¸ç©ºé—´ä¸Šé«˜æ•ˆçš„æ›´ä¼˜ç§€ç­–ç•¥ã€‚

è¯¥éƒ¨åˆ†ä»£ç å‚è€ƒ`final_pass.c`

æ˜¾ç„¶è¿™æ ·ä¸æ˜¯æœ€ä¼˜çš„ï¼Œå‚è€ƒ`test-case6.c`ä»£ç 


```c
int *x,*y,*z;
int foo2(int *x,int *y)
{
	return *y;
}
int foo1(int *x,int *y)
{
	
	if ((*x)*2<*y) 
	{
		return *x;
	}
	else 
	{
		return foo2(x,*y+1);
	}
	
}
int foo(int *a,int *b,int *c)
{
	if (*a>*c) 
	{
		return foo1(a,c);
	}
	else
	{
		return foo2(b,c);
	}
}
int main()
{
	x=malloc(sizeof(int));
	y=malloc(sizeof(int));
	int n=10;
	*x=3;*y=4;z=&n;
	int ans=foo(x,y,z);
}
```

å› ä¸ºæˆ‘ä»¬ä¼šåœ¨æœ€æ—©èƒ½freeçš„åœ°æ–¹freeï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œç»“æœæ˜¯

```c
int *x,*y,*z;
int foo2(int *x,int *y)
{
	return *y;
}
int foo1(int *x,int *y)
{
	
	if ((*x)*2<*y) 
	{
		return *x;
	}
	else 
	{
/*Created by our project*/	free(x);	/************************/
		return foo2(x,*y+1);
	}
	
}
int foo(int *a,int *b,int *c)
{
	if (*a>*c) 
	{
		return foo1(a,c);
	}
	else
	{
/*Created by our project*/	free(a);	/************************/
		return foo2(b,c);
	}
}
int main()
{
	x=malloc(sizeof(int));
	y=malloc(sizeof(int));
	int n=10;
	*x=3;*y=4;z=&n;
/*Created by our project*/	free(y);	/************************/
	int ans=foo(x,y,z);
}
/*Warning created by our project
	After fixing, malloc in line34 may still cause memory leaking.
		Dereference when return
*******************************/

```

å¯ä»¥çœ‹åˆ°free(x)å’Œfree(a)çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†free main()ä¸­mallocå‡ºæ¥çš„ï¼ŒxæŒ‡å‘çš„å†…å­˜åŒºåŸŸã€‚

è¿™å°±æ˜¯æˆ‘ä»¬çš„è´ªå¿ƒçš„åä¾‹ã€‚å› ä¸ºæ˜¾ç„¶åœ¨`int ans=foo(x,y,z);`ä¹‹åfree(x)æ›´åŠ å®‰å…¨ã€‚

#æµ‹è¯•ç”¨ä¾‹è®¾è®¡

æˆ‘ä»¬æ€»å…±è®¾è®¡äº†13ç»„æµ‹è¯•æ•°æ®ã€‚

å…¶ä¸­10ç»„æ˜¯æ‰‹å·¥æ„é€ çš„ï¼Œ3ç»„å¤§æ•°æ®ç”±ä»£ç éšæœºç”Ÿæˆã€‚

æ‰‹å·¥æ„é€ çš„æ•°æ®ä¸­å­˜åœ¨åƒtest6.cè¿™æ ·çš„è´ªå¿ƒåä¾‹ï¼Œä¹Ÿå­˜åœ¨ä¸€äº›å…¶ä»–çš„æ„é€ æ•°æ®ã€‚

è€Œä¸”å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„ä¿®å¤ä¸­è¿˜æ”¯æŒå¯¹äºä¸èƒ½ä¿®å¤çš„åœ°æ–¹æŠ¥å‡ºwarningï¼Œæ–¹ä¾¿ç”¨æˆ·æ›´åŠ ç²¾ç¡®åœ°ä¿®å¤ã€‚

###test1.c

ç›®æ ‡æ˜¯æµ‹è¯•ç¨‹åºå¯¹å¤šé‡æŒ‡é’ˆçš„ä¿®å¤èƒ½åŠ›ã€‚

ä»£ç ä¸º

```c
int main()
{
	int **z=malloc(sizeof(int*));
	*z=malloc(sizeof(int));
	**z=0;
	return 0;
}
```

ä¿®å¤ç»“æœä¸º

```c
int main()
{
	int **z=malloc(sizeof(int*));
	*z=malloc(sizeof(int));
	**z=0;
/*Created by our project*/	free(*z);	/************************/
/*Created by our project*/	free(z);	/************************/
	return 0;
}
```

å¯ä»¥çœ‹å‡ºæ¥ä¿®å¤æ— è¯¯ï¼Œè¿™ç¦»ä¸å¼€æŒ‡é’ˆåˆ†æä¸å‰ä¸¤æ¬¡åˆ†æä¸ºæˆ‘ä»¬æä¾›çš„å„å˜é‡æŒ‡å‘å†…å­˜çš„ä¿¡æ¯ã€‚

###test2.c
ç›®æ ‡ä¸ºæµ‹è¯•é¢å¯¹åˆ†æ”¯æ—¶ç¨‹åºçš„ä¿®å¤èƒ½åŠ›ã€‚

ä»£ç ä¸º

```c
int *x;
int main()
{
	int *y=malloc(sizeof(int));
	x=malloc(sizeof(int));
	*x=0;
	*y=1;
	if (*x>*y)
	{
		int *z=malloc(sizeof(int));
		*z=*y;
	}
	else
	{
		x=y;
		//free(y);
	}
	return 0;
}
```

ä¿®å¤ç»“æœä¸º

```c
int *x;
int main()
{
	int *y=malloc(sizeof(int));
	x=malloc(sizeof(int));
	*x=0;
	*y=1;
	if (*x>*y)
	{
/*Created by our project*/	free(x);	/************************/
		int *z=malloc(sizeof(int));
		*z=*y;
/*Created by our project*/	free(y);	/************************/
/*Created by our project*/	free(z);	/************************/
	}
	else
	{
/*Created by our project*/	free(y);	/************************/
/*Created by our project*/	free(x);	/************************/
		x=y;
		//free(y);
	}
	return 0;
}
```

å€¼å¾—æ³¨æ„çš„æ˜¯elseé‡Œæˆ‘ä»¬åœ¨x=yè¿™å¥ä¹‹å‰å°±æŠŠx,yéƒ½ç»™freeæ‰äº†ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å·²ç»åˆ¤å®šx,yæ‰€æŒ‡å‘çš„å†…å­˜ç©ºé—´ä¹‹åå†ä¹Ÿä¸ä¼šè¢«ç”¨åˆ°äº†ã€‚

### test3.c

ä¸test2æµ‹è¯•ç›®çš„ç›¸åŒï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸ºäº†æµ‹è¯•åœ¨åˆ†æ”¯ä¸‹çš„é²æ£’æ€§ï¼Œä»£ç å‡ ä¹ä¹Ÿä¸test2ä¸€æ ·

```c
int *x;
int main()
{
	int *y=malloc(sizeof(int));
	x=malloc(sizeof(int));
	*x=0;
	*y=1;
	if (*x>*y)
	{
		int *z=malloc(sizeof(int));
		*z=*y;
	}
	else
	{
		x=y;
		free(y);
	}
	return 0;
}
```

test3ä¸test2æœ€å¤§çš„åŒºåˆ«å°±åœ¨äºelseä¸­åŠ å…¥äº†freeè¯­å¥ï¼Œäºæ˜¯æˆ‘ä»¬ä¸èƒ½åœ¨x=yä¹‹å‰å°†y freeæ‰äº†ã€‚

ä¿®å¤ç»“æœä¸º

```c
int *x;
int main()
{
	int *y=malloc(sizeof(int));
	x=malloc(sizeof(int));
	*x=0;
	*y=1;
	if (*x>*y)
	{
/*Created by our project*/	free(x);	/************************/
		int *z=malloc(sizeof(int));
		*z=*y;
/*Created by our project*/	free(y);	/************************/
/*Created by our project*/	free(z);	/************************/
	}
	else
	{
		x=y;
		free(y);
	}
	return 0;
}
/*Warning created by our project
	After fixing, malloc in line4 may still cause memory leaking.
	After fixing, malloc in line5 may still cause memory leaking.
*******************************/
```

æ³¨æ„åˆ°elseåˆ†æ”¯ä¸­ï¼Œxä¸€å¼€å§‹mallocå‡ºçš„é‚£ç‰‡å†…å­˜å¯èƒ½ä¼šæ³„æ¼ï¼Œä½†æ˜¯åœ¨free(y)çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ¤æ–­xå’ŒyæŒ‡å‘çš„é›†åˆç›¸åŒï¼ˆå› ä¸ºSteengardçš„ç¼ºé™·ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬æ— æ³•åŒºxå’Œyï¼Œwarningä¹Ÿæ˜¯å¦‚æ­¤ã€‚

### test4.c

ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æµ‹è¯•å¾ªç¯æƒ…å†µä¸‹çš„ä¿®å¤èƒ½åŠ›ã€‚

```c
int main()
{
	int b=10;
	int *x=&b;
	for(int i=1;i<=b;i++)
	{
		int *z=malloc(sizeof(int));
		*z=*x+i;
		if (*z>i*2)
		{
			break;
		}
		else
		{
			i++;
		}
	}
	return 0;
}
```

ä¿®å¤ç»“æœä¸º

```c
int main()
{
	int b=10;
	int *x=&b;
	for(int i=1;i<=b;i++)
	{
		int *z=malloc(sizeof(int));
		*z=*x+i;
		if (*z>i*2)
		{
/*Created by our project*/	free(z);	/************************/
			break;
		}
		else
		{
			i++;
		}
	}
	return 0;
}
```

ä¼šæ³¨æ„åˆ°æˆ‘ä»¬çš„ç¨‹åºå°‘freeäº†elseåˆ†æ”¯æ—¶çš„zã€‚*ä½†æ˜¯ç”±äºå¯¹äºå¾ªç¯çš„å¤„ç†ä¸æ˜¯å¾ˆåˆ°ä½ï¼Œæ²¡æ³•åˆ¤æ–­warningã€‚*

è¿™ä¸€ç‚¹ä¸æˆ‘ä»¬å»ºcfgæ—¶å¤„ç†å¾ªç¯çš„æ–¹å¼æœ‰å…³ï¼Œä¸é€’å½’ç›¸åŒï¼Œæˆ‘ä»¬åŒæ ·ä¹Ÿéš¾ä»¥åˆ¤æ–­å¾ªç¯æ‰§è¡Œçš„æƒ…å†µã€‚

### test5.c

```c
void swap(int*x,int*y)
{
	int *t=x;
	x=y;
	y=x;
}
int main()
{
	int *haha=malloc(sizeof(int));
	int *youcantcatchme=haha;
	*haha=1;
	int *x=malloc(sizeof(int));
	swap(x,haha);
	*youcantcatchme=0;
	}
```

è¿™æ®µä»£ç ä¹Ÿä¸»è¦æ˜¯åœ¨hackæˆ‘ä»¬çš„ç¨‹åºï¼Œå¯ä»¥çœ‹å‡ºæ¥swapå‡½æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ— å‰¯ä½œç”¨çš„å‡½æ•°ã€‚

ä½†æ˜¯åŠ ä¸Šäº†è¿™ä¸ªå‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬ä¿®å¤çš„ç»“æœä¸º

```c
void swap(int*x,int*y)
{
	int *t=x;
	x=y;
	y=x;
}
int main()
{
	int *haha=malloc(sizeof(int));
	int *youcantcatchme=haha;
	*haha=1;
	int *x=malloc(sizeof(int));
	swap(x,haha);
	*youcantcatchme=0;
/*Created by our project*/	free(x);	/************************/
}
/*Warning created by our project
	After fixing, malloc in line12 may still cause memory leaking.
	After fixing, malloc in line9 may still cause memory leaking.
*******************************/
```

è¡¨ç°å‡ºæ¥çš„æ˜¯æˆ‘ä»¬å°‘freeäº†hahaå£°æ˜æ—¶allocå‡ºçš„å˜é‡ã€‚è¿™æ˜¯å› ä¸ºç¨‹åºåˆ†ææ—¶ï¼Œæˆ‘ä»¬æ•°æ®æµåˆ†æè¿›è¡Œçš„æ˜¯è¿‘ä¼¼åˆ†æï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°è¿™ä¸ªæƒ…å†µã€‚

###test6.c

å³ä¹‹å‰åˆ†æè¿‡çš„è¯´è´ªå¿ƒæ·»åŠ freeå¯èƒ½ä¸å¤Ÿä¼˜çš„é—®é¢˜ã€‚

###test7.c

```c
int *sum;
void foo(int x)
{
	*sum*=x;
	if (x==1)
	{
		return ;
	}
	foo(x-1);
}
int main()
{
	sum=malloc(sizeof(int));
	foo(10);
	return 0;
}
```

å®¹æ˜“çœ‹å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªç®€å•çš„é˜¶ä¹˜è®¡ç®—ç¨‹åºã€‚

é€’å½’ç¨‹åºçš„ä¸»è¦é—®é¢˜åœ¨äºæˆ‘ä»¬éš¾ä»¥æ„é€ å‡ºç²¾ç¡®çš„CFGï¼ˆå› ä¸ºä¸çŸ¥é“é€’å½’æ·±åº¦ã€é€’å½’åˆ†æ”¯æƒ…å†µç­‰ï¼‰

æˆ‘ä»¬é‡‡å–çš„æ˜¯Clone-based Context-Sensitive Analysisæ¥è¿›è¡ŒInterprocedural Analysisã€‚

é¢å¯¹é€’å½’çš„æ—¶å€™ä¼šç›´æ¥å±•å¼€kæ­¥è¿›è¡Œå¤åˆ¶æ›¿æ¢ã€‚

ç¨‹åºä¿®å¤ç»“æœä¸º

```c
int *sum;
void foo(int x)
{
	*sum*=x;
	if (x==1)
	{
		return ;
	}
	foo(x-1);
}
int main()
{
	sum=malloc(sizeof(int));
	foo(10);
/*Created by our project*/	free(sum);	/************************/
	return 0;
}
```

å¯ä»¥çœ‹å‡ºé¢å¯¹è¿™æ ·ç®€å•çš„é€’å½’ï¼Œæˆ‘ä»¬çš„ç®—æ³•å·¥ä½œæ­£å¸¸ã€‚

ä¸­é—´è°ƒè¯•ä¿¡æ¯å¯ä»¥å‚è€ƒ`test7-extra.txt`ï¼Œå› ä¸ºè¿‡é•¿æ•…ä¸åœ¨æ­¤åˆ—å‡ºã€‚

### test8.c

ä¸»è¦æ˜¯æµ‹è¯•å¤šé‡å¾ªç¯åŠå˜é‡é‡åæ—¶ç¨‹åºçš„å¤„ç†èƒ½åŠ›ã€‚

```c
int main()
{
	int n=10;
	int *x=&n;
	for(int i=1;i<=n;i++)
	{
		int *x=malloc(sizeof(int));
		for(int j=1;j<=n;j++)
		{
			int *x=malloc(sizeof(int));
		}
	}
	return 0;
}
```

ç»“æœä¸º

```c
int main()
{
	int n=10;
	int *x=&n;
	for(int i=1;i<=n;i++)
	{
		int *x=malloc(sizeof(int));
/*Created by our project*/	free(x);	/************************/
		for(int j=1;j<=n;j++)
		{
			int *x=malloc(sizeof(int));
/*Created by our project*/	free(x);	/************************/
		}
	}
	return 0;
}
```

è¿™ä¸ªä¿®å¤ç»“æœè¿˜æ˜¯ä»¤äººæ»¡æ„çš„ã€‚

###test9.c

åŒæ ·ï¼Œä¸test7ç±»ä¼¼ï¼Œè¿˜æ˜¯æµ‹è¯•é€’å½’å‡½æ•°ï¼Œè¿™æ¬¡é€‰æ‹©äº†fibonacciå‡½æ•°ï¼Œå¹¶ä¸”åœ¨é€’å½’æ—¶mallocã€‚

```c
int fib(int n)
{
	int *ret;
	if (n==0)
	{
		return 1;
	}
	ret=malloc(sizeof(int));
	if (n==1)
	{
		return 1;
	}
	*ret=fib(n-1) + fib(n-2);
	return *ret;
}
int main()
{
	fib(10);
	return 0;
}
```

ç»“æœä¸º

```c
int fib(int n)
{
	int *ret;
	if (n==0)
	{
		return 1;
	}
	ret=malloc(sizeof(int));
	if (n==1)
	{
/*Created by our project*/	free(ret);	/************************/
		return 1;
	}
	*ret=fib(n-1) + fib(n-2);
	return *ret;
}
int main()
{
	fib(10);
	return 0;
}

/*Warning created by our project
	After fixing, malloc in line8 may still cause memory leaking.
		Dereference when return
*******************************/
```

æ•ˆæœå¹¶ä¸å¥½ï¼Œè¿™ä¹Ÿæ˜¯å¯ä»¥é¢„è§åˆ°çš„ï¼Œæ¯•ç«Ÿæ ¹æ®æˆ‘ä»¬çš„ç®—æ³•ï¼Œåªæœ‰n==1çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯freeæ‰(ret)è€Œåˆä¸æ”¹å˜è¯­ä¹‰ä¿¡æ¯ã€‚

æ¯•ç«Ÿæˆ‘ä»¬æ‰€æ‰§è¡Œçš„ä¿®æ”¹åªæœ‰æ·»åŠ freeå—æ‰€ä»¥åœ¨returnè°ƒç”¨äº†*retçš„è¯ï¼Œæˆ‘ä»¬å®Œå…¨æ²¡æœ‰æœºä¼šé€šè¿‡æ·»åŠ freeæ¥é‡Šæ”¾mallocå‡ºçš„ç©ºé—´ã€‚

###test10.c

```c
int *x;
int a()
{
	
}
int b()
{
	a();
}
int main()
{
	x=malloc(sizeof(int));
	a();
	*x=1;
	b();
	return 0;
}
```

ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•åœ¨è·¨è¶Šå‡ ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¯¹ä¸€ä¸ªå˜é‡çš„è¿½è¸ªèƒ½åŠ›ã€‚

ç»“æœä¸º

```c
int *x;
int a()
{
	
}
int b()
{
	a();
}
int main()
{
	x=malloc(sizeof(int));
	a();
	*x=1;
/*Created by our project*/	free(x);	/************************/
	b();
	return 0;
}
```

ç»“æœä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚


å¯¹äºæ‰‹å·¥æ„é€ æ•°æ®çš„åˆ†æåˆ°æ­¤ç»“æŸã€‚


#å®Œæˆæƒ…å†µä¸å­˜åœ¨çš„é—®é¢˜

æˆ‘ä»¬å®Œæˆäº†å¼€é¢˜æŠ¥å‘Šä¸­çš„å…¨éƒ¨ç›®æ ‡ã€‚ä½†æˆ‘ä»¬çš„é¡¹ç›®ä»å­˜åœ¨ä¸€äº›é—®é¢˜:

* å¯¹é€’å½’æ—¶äº§ç”Ÿçš„å†…å­˜æ³„æ¼è§£å†³èƒ½åŠ›è¾ƒå·®ï¼Œè¿™ä¸€ç‚¹éœ€è¦æ›´å¥½çš„æ„é€ CFGæ¥è§£å†³ã€‚
* ç­–ç•¥ä¸Šçš„é—®é¢˜ï¼Œä¼šæœ‰ä¸€äº›å¯ä»¥ä¿®å¤çš„æ³„æ¼æˆ‘ä»¬æ²¡æœ‰ä¿®å¤ï¼Œæˆ–è€…åŠ å…¥çš„freeè¯­å¥è¿‡å¤šï¼ŒæœŸå¾…èƒ½æ‰¾åˆ°æ›´å¥½çš„ç­–ç•¥ã€‚


#è‡´è°¢

* æ„Ÿè°¢æ‰€æœ‰æˆå‘˜çš„ä»˜å‡ºä¸åˆä½œ
* æ„Ÿè°¢è€å¸ˆå’ŒåŠ©æ•™çš„æŒ‡å¯¼
* æ„Ÿè°¢å…¶ä»–åŒå­¦çš„å»ºè®®ä¸æ”¯æŒ


